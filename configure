#!/bin/sh

config_mk="config.mk"

usage_message="Usage: ./configure
Produce a config.mk file to be sourced by Makefile
--prefix=<dir>
    Install architecture-independent files in \$prefix (e.g. --prefix=\$HOME')
--with-xfce4-panel-applet
    Include contrib/ package xfce4-panel-applet
--with-gtktheme
    Include contrib/ package gtktheme
--enable-asan
    Enable address sanitizer. Only use during development.
-a, --all
    Include all contrib/ packages above
"

add () {
	printf '%b\n' "$*" >>"$config_mk"
}

check_required_bins () {
	for bin
	do
		if ! type "$bin" >/dev/null 2>&1; then
			printf '%b\n' "[FAIL] cannot find $bin"
			exit 1
		else
			printf '%b\n' "[ OK ] $bin"
		fi
	done
}

check_required_libs () {
	for lib
	do
		if ! pkg-config "$lib" >/dev/null 2>&1; then
			printf '%b\n' "[FAIL] cannot find $lib"
			exit 1
		else
			printf '%b\n' "[ OK ] $lib"
		fi
	done
}

main () {
	rm -rf $config_mk
	add "# Generated by configure script"

	check_required_bins pkg-config xml2-config
	check_required_libs x11 xrandr cairo pango pangocairo librsvg-2.0

	for arg
	do
		opt=${arg%%=*}
		var=${arg#*=}
		case "$opt" in
		--prefix)
			add "prefix = $var" ;;
		--with-xfce4-panel-applet)
			check_required_libs libxfce4panel-1.0
			add "CONTRIB_DIRS += xfce4-panel" ;;
		--with-gtktheme)
			add "CONTRIB_DIRS += gtktheme" ;;
		--enable-asan)
			add "ASAN=1" ;;
		-a|--all)
			add "CONTRIB_DIRS += xfce4-panel"
			add "CONTRIB_DIRS += gtktheme"
			;;
		-h|--help)
			printf '%b' "$usage_message"; exit 1 ;;
		*)
			printf '%b\n' "warn: unknown option $opt" >&2 ;;
		esac
	done
}

main "$@"
